{% extends 'base.html' %}
{% block content %}

<div class="orders-wrapper">

    <!-- ===== HEADER ===== -->
    <header class="orders-header sticky-header">
        <div class="header-left">
            <h1>ğŸ“¦ Orders Dashboard</h1>
            <p>Monitor all client orders in one place</p>
        </div>
        <div class="header-right">
            {% if session.get('username') != 'admin' %}
                <a href="{{ url_for('client_form') }}" class="btn primary-btn">ï¼‹ New Order</a>
            {% endif %}
            <a href="{{ url_for('admin_dashboard') }}" class="btn secondary-btn">â† Dashboard</a>
            <button onclick="window.print()" class="btn print-btn">ğŸ–¨ Print All</button>
        </div>
    </header>

    <!-- ===== SUMMARY PANELS ===== -->
    <section class="orders-summary">
        <div class="summary-panel">
            <div class="summary-icon">ğŸ“¦</div>
            <div class="summary-content">
                <h3>Total Orders</h3>
                <span>{{ soya_orders|length + cashew_orders|length + maize_orders|length + rice_orders|length }}</span>
            </div>
        </div>
        <div class="summary-panel">
            <div class="summary-icon">ğŸ«˜</div>
            <div class="summary-content">
                <h3>Soya Orders</h3>
                <span>{{ soya_orders|length }}</span>
            </div>
        </div>
        <div class="summary-panel">
            <div class="summary-icon">ğŸ¥œ</div>
            <div class="summary-content">
                <h3>Cashew Orders</h3>
                <span>{{ cashew_orders|length }}</span>
            </div>
        </div>
        <div class="summary-panel">
            <div class="summary-icon">ğŸŒ½</div>
            <div class="summary-content">
                <h3>Maize Orders</h3>
                <span>{{ maize_orders|length }}</span>
            </div>
        </div>
        <div class="summary-panel">
            <div class="summary-icon">ğŸš</div>
            <div class="summary-content">
                <h3>Rice Orders</h3>
                <span>{{ rice_orders|length }}</span>
            </div>
        </div>
    </section>

    <!-- ===== FILTER PANEL ===== -->
    <aside class="filter-panel">
        <h3>Filter Orders</h3>

        <div class="filter-buttons">
            <button class="filter-btn active" data-category="all">All</button>
            <button class="filter-btn" data-category="soya">Soya Beans</button>
            <button class="filter-btn" data-category="cashew">Cashew Nut</button>
            <button class="filter-btn" data-category="maize">Maize</button>
            <button class="filter-btn" data-category="rice">Rice</button>
        </div>

        <div class="filter-time" style="margin-top:12px;">
            <label for="time-filter">Time:</label>
            <select id="time-filter">
                <option value="all">All</option>
                <option value="day">Today</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
            </select>
        </div>

        <!-- âœ… ADDED MODERN DATE SEARCH -->
        <div style="margin-top:12px;">
            <label for="date-search">Search Date:</label>
            <input type="date" id="date-search"
                   style="width:100%;padding:8px;border-radius:6px;border:1px solid #d1d5db;">
        </div>
    </aside>

    <!-- ===== ORDERS GRID ===== -->
    <section class="orders-grid">

        {% macro order_row(order, sn) %}
        <div class="order-row"
             data-category="{{ order.items|lower|replace(' ', '') }}"
             data-date="{{ order.date.strftime('%Y-%m-%d') if order.date else '' }}">
            <div class="row-header">
                <span class="sn">#{{ sn }}</span>
                <span class="product">{{ order.items }}</span>
                <span class="status {{ order.status|lower }}">{{ order.status }}</span>
                <button class="toggle-btn">Details â–¼</button>
            </div>
            <div class="row-details">
                <div class="details-section">
                    <h4>Client Info</h4>
                    <p><strong>Name:</strong> {{ order.name }}</p>
                    <p><strong>Email:</strong> {{ order.email or "â€”" }}</p>
                    <p><strong>Phone:</strong> {{ order.phone_number or "â€”" }}</p>
                    <p><strong>Bank:</strong> {{ order.bank_name or "â€”" }}</p>
                    <p><strong>Date:</strong> {{ order.date.strftime('%d %b %Y') if order.date else "â€”" }}</p>
                </div>
                <div class="details-section">
                    <h4>Order Details</h4>
                    <p><strong>Description:</strong> {{ order.description or "â€”" }}</p>
                    <p><strong>Quantity:</strong> {{ order.kilograms or 0 }} kg</p>
                    <p><strong>Unit Price:</strong> â‚¦{{ "%.2f"|format(order.unit_price or 0) }}</p>
                    <p><strong>Total:</strong> â‚¦{{ "%.2f"|format(order.total_amount or 0) }}</p>
                </div>
                <div class="details-section">
                    <h4>Delivery Info</h4>
                    <p><strong>Driver:</strong> {{ order.driver_name or "â€”" }}</p>
                    <p><strong>Vehicle:</strong> {{ order.vehicle_plate_number or "â€”" }}</p>
                    <p><strong>Account:</strong> {{ order.account_number or "â€”" }}</p>
                    <p><strong>Bank:</strong> {{ order.account_bank_name or "â€”" }}</p>
                </div>
                <div class="details-section">
                    <h4>Timestamps</h4>
                    <p><strong>Created:</strong> {{ order.created_at.strftime('%d %b %Y, %I:%M %p') if order.created_at else 'â€”' }}</p>
                    <p><strong>Confirmed:</strong> {{ order.confirmed_at.strftime('%d %b %Y, %I:%M %p') if order.confirmed_at else 'Pending' }}</p>
                </div>
                <div class="row-actions">
                    {% if order.status != 'Confirmed' %}
                        <form method="POST" action="{{ url_for('confirm_order', order_id=order.id) }}">
                            <button class="btn success-btn">âœ” Confirm</button>
                        </form>
                    {% else %}
                        <button class="btn success-btn disabled">âœ… Confirmed</button>
                    {% endif %}
                    <form method="POST" action="{{ url_for('delete_order', order_id=order.id) }}" onsubmit="return confirm('Delete this order?');">
                        <button class="btn danger-btn">ğŸ—‘ Delete</button>
                    </form>
                    <button class="btn print-btn" onclick="printOrder(this)">ğŸ–¨ Print</button>
                </div>
            </div>
        </div>
        {% endmacro %}

        {% set categories = {"soya": soya_orders, "cashew": cashew_orders, "maize": maize_orders, "rice": rice_orders} %}
        {% set sn = 1 %}
        {% for cat, orders in categories.items() %}
            {% for order in orders %}
                {{ order_row(order, sn) }}
                {% set sn = sn + 1 %}
            {% endfor %}
        {% endfor %}
    </section>
</div>

<!-- ===== FIXED FILTER SCRIPT ===== -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    const buttons = document.querySelectorAll('.filter-btn');
    const rows = document.querySelectorAll('.order-row');
    const timeFilter = document.getElementById('time-filter');
    const dateSearch = document.getElementById('date-search');

    function filterOrders() {
        const activeCategory = document.querySelector('.filter-btn.active').dataset.category;
        const timeValue = timeFilter.value;
        const searchDate = dateSearch.value;

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const monthStr = todayStr.slice(0,7);
        const yearStr = todayStr.slice(0,4);

        rows.forEach(row => {
            const rowCategory = row.dataset.category;
            const rowDate = row.dataset.date;
            let show = true;

            if (activeCategory !== 'all' && !rowCategory.includes(activeCategory)) {
                show = false;
            }

            if (show && timeValue !== 'all') {
                if (timeValue === 'day' && rowDate !== todayStr) show = false;
                if (timeValue === 'month' && !rowDate.startsWith(monthStr)) show = false;
                if (timeValue === 'year' && !rowDate.startsWith(yearStr)) show = false;
            }

            if (show && searchDate && rowDate !== searchDate) {
                show = false;
            }

            row.style.display = show ? 'block' : 'none';
        });
    }

    buttons.forEach(btn => {
        btn.addEventListener('click', () => {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterOrders();
        });
    });

    timeFilter.addEventListener('change', filterOrders);
    dateSearch.addEventListener('change', filterOrders);
});
</script>

{% endblock %}
